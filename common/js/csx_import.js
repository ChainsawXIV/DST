
// DDI Character Builder File Importer

csx_ddi_schema = {
	"dsf_passive_perception_skill":"Perception",
	"dsf_passive_perception":"Passive Perception",
	"dsf_passive_insight_skill":"Insight",
	"dsf_passive_insight":"Passive Insight",
	"dsf_speed_armor":"Speed.Armor",
	"dsf_speed_base":"Base Speed",
	"dsf_speed":"Speed",
	"dsf_action_points":"_BaseActionPoints",
	"dsf_will_ten_plus_half":"Ten Plus Half Level",
	"dsf_will_ability":"Will Ability Modifier",
	"dsf_will_class":"Will Defense Class Bonus",
	"dsf_will_feat":"Will.Feat",
	"dsf_will_enhancement":"Will.Enhancement",
	"dsf_will":"Will",
	"dsf_reflex_ten_plus_half":"Ten Plus Half Level",
	"dsf_reflex_ability":"Reflex Ability Modifier",
	"dsf_reflex_class":"Reflex Defense Class Bonus",
	"dsf_reflex_feat":"Reflex.Feat",
	"dsf_reflex_enhancement":"Reflex.Enhancement",
	"dsf_reflex_misc_a":"Reflex.Shield",
	"dsf_reflex":"Reflex",
	"dsf_fortitude_ten_plus_half":"Ten Plus Half Level",
	"dsf_fortitude_ability":"Fortitude Ability Modifier",
	"dsf_fortitude_class":"Fortitude Defense Class Bonus",
	"dsf_fortitude_feat":"Fortitude.Feat",
	"dsf_fortitude_enhancement":"Fortitude.Enhancement",
	"dsf_fortitude":"Fortitude",
	"dsf_ac_ten_plus_half":"Ten Plus Half Level",
	"dsf_ac_ability":"AC Ability Modifier",
	"dsf_ac_class":"AC Defense Class Bonus",
	"dsf_ac_feat":"AC.Feat",
	"dsf_ac_enhancement":"Armor Enhancement Bonus",
	"dsf_ac_misc_a":"AC.Shield",
	"dsf_ac":"AC",
	"dsf_thievery_ability_plus_half":"Dexterity Plus Half Level",
	"dsf_thievery_training":"Thievery Trained",
	"dsf_thievery_armor":"Armor Penalty",
	"dsf_thievery_misc":"Thievery Misc",
	"dsf_thievery":"Thievery",
	"dsf_streetwise_ability_plus_half":"Charisma Plus Half Level",
	"dsf_streetwise_training":"Streetwise Trained",
	"dsf_streetwise_misc":"Streetwise Misc",
	"dsf_streetwise":"Streetwise",
	"dsf_stealth_ability_plus_half":"Dexterity Plus Half Level",
	"dsf_stealth_training":"Stealth Trained",
	"dsf_stealth_armor":"Armor Penalty",
	"dsf_stealth_misc":"Stealth Misc",
	"dsf_stealth":"Stealth",
	"dsf_religion_ability_plus_half":"Intelligence Plus Half Level",
	"dsf_religion_training":"Religion Trained",
	"dsf_religion_misc":"Religion Misc",
	"dsf_religion":"Religion",
	"dsf_perception_ability_plus_half":"Wisdom Plus Half Level",
	"dsf_perception_training":"Perception Trained",
	"dsf_perception_misc":"Perception Misc",
	"dsf_perception":"Perception",
	"dsf_nature_ability_plus_half":"Wisdom Plus Half Level",
	"dsf_nature_training":"Nature Trained",
	"dsf_nature_misc":"Nature Misc",
	"dsf_nature":"Nature",
	"dsf_intimidate_ability_plus_half":"Charisma Plus Half Level",
	"dsf_intimidate_training":"Intimidate Trained",
	"dsf_intimidate_misc":"Intimidate Misc",
	"dsf_intimidate":"Intimidate",
	"dsf_insight_ability_plus_half":"Wisdom Plus Half Level",
	"dsf_insight_training":"Insight Trained",
	"dsf_insight_misc":"Insight Misc",
	"dsf_insight":"Insight",
	"dsf_history_ability_plus_half":"Intelligence Plus Half Level",
	"dsf_history_training":"History Trained",
	"dsf_history_misc":"History Misc",
	"dsf_history":"History",
	"dsf_heal_ability_plus_half":"Wisdom Plus Half Level",
	"dsf_heal_training":"Heal Trained",
	"dsf_heal_misc":"Heal Misc",
	"dsf_heal":"Heal",
	"dsf_endurance_ability_plus_half":"Constitution Plus Half Level",
	"dsf_endurance_training":"Endurance Trained",
	"dsf_endurance_armor":"Armor Penalty",
	"dsf_endurance_misc":"Endurance Misc",
	"dsf_endurance":"Endurance",
	"dsf_dungeoneering_ability_plus_half":"Wisdom Plus Half Level",
	"dsf_dungeoneering_training":"Dungeoneering Trained",
	"dsf_dungeoneering_misc":"Dungeoneering Misc",
	"dsf_dungeoneering":"Dungeoneering",
	"dsf_diplomacy_ability_plus_half":"Charisma Plus Half Level",
	"dsf_diplomacy_training":"Diplomacy Trained",
	"dsf_diplomacy_misc":"Diplomacy Misc",
	"dsf_diplomacy":"Diplomacy",
	"dsf_bluff_ability_plus_half":"Charisma Plus Half Level",
	"dsf_bluff_training":"Bluff Trained",
	"dsf_bluff_misc":"Bluff Misc",
	"dsf_bluff":"Bluff",
	"dsf_athletics_ability_plus_half":"Strength Plus Half Level",
	"dsf_athletics_training":"Athletics Trained",
	"dsf_athletics_armor":"Armor Penalty",
	"dsf_athletics_misc":"Athletics Misc",
	"dsf_athletics":"Athletics",
	"dsf_arcana_ability_plus_half":"Intelligence Plus Half Level",
	"dsf_arcana_training":"Arcana Trained",
	"dsf_arcana_misc":"Arcana Misc",
	"dsf_arcana":"Arcana",
	"dsf_acrobatics_ability_plus_half":"Dexterity Plus Half Level",
	"dsf_acrobatics_training":"Acrobatics Trained",
	"dsf_acrobatics_armor":"Armor Penalty",
	"dsf_acrobatics_misc":"Acrobatics Misc",
	"dsf_acrobatics":"Acrobatics",
	"dsf_surges":"Healing Surges",
	"dsf_surge_value":"Surge Value",
	"dsf_bloodied":"Bloodied Value",
	"dsf_hit_points":"Hit Points",
	"dsf_charisma_mod":"Charisma modifier",
	"dsf_charisma_mod_plus_half":"Charisma Plus Half Level",
	"dsf_charisma":"Charisma",
	"dsf_wisdom_mod":"Wisdom modifier",
	"dsf_wisdom_mod_plus_half":"Wisdom Plus Half Level",
	"dsf_wisdom":"Wisdom",
	"dsf_intelligence_mod":"Intelligence modifier",
	"dsf_intelligence_mod_plus_half":"Intelligence Plus Half Level",
	"dsf_intelligence":"Intelligence",
	"dsf_dexterity_mod":"Dexterity modifier",
	"dsf_dexterity_mod_plus_half":"Dexterity Plus Half Level",
	"dsf_dexterity":"Dexterity",
	"dsf_constitution_mod":"Constitution modifier",
	"dsf_constitution_mod_plus_half":"Constitution Plus Half Level",
	"dsf_constitution":"Constitution",
	"dsf_strength_mod":"Strength modifier",
	"dsf_strength_mod_plus_half":"Strength Plus Half Level",
	"dsf_strength":"Strength",
	"dsf_initiative_dex":"Dexterity modifier",
	"dsf_initiative_half":"HALF-LEVEL",
	"dsf_initiative_misc":"Initiative Misc",
	"dsf_initiative":"Initiative",
	"dsf_affiliation":"Company",
	"dsf_deity":"Deity",
	"dsf_alignment":"Alignment",
	"dsf_weight":"Weight",
	"dsf_height":"Height",
	"dsf_gender":"Gender",
	"dsf_age":"Age",
	"dsf_size":"Size",
	"dsf_race":"Race",
	"dsf_xp":"Experience",
	"dsf_epic_destiny":"Epic Destiny",
	"dsf_paragon_path":"Paragon Path",
	"dsf_class":"Class",
	"dsf_level":"Level",
	"dsf_dailyPowers":{
		"source":"Daily Powers",
		"fields":{
			"mod":"name"
		}
	},
	"dsf_encounterPowers":{
		"source":"Encounter Powers",
		"fields":{
			"mod":"name"
		}
	},
	"dsf_atwillPowers":{
		"source":"At-Will Powers",
		"fields":{
			"mod":"name"
		}
	},
	"dsf_senses":{
		"source":"Vision",
		"fields":{
			"mod":"name"
		}
	},
	"dsf_languages":{
		"source":"Language",
		"fields":{
			"mod":"name"
		}
	},
	"dsf_feats":{
		"source":"Feat",
		"fields":{
			"link":"url",
			"mod":"name"
		}
	},
	"dsf_classFeature":{
		"source":"Class Feature",
		"fields":{
			"top":"desc",
			"mod":"name"
		}
	},
	"dsf_raceFeature":{
		"source":"Racial Trait",
		"fields":{
			"tip":"desc",
			"mod":"name"
		}
	}
};

function csx_importFile(){

	// Abort if no file was selected
	var file = document.querySelector( '.import_browser' ).files[ 0 ];
	if ( file == null )
		return;
		
	// Warn the user about overwrite and confirm
	document.querySelector( '.import_confirm' ).style.display = 'none';
	var proceed = window.confirm( 'Importing a character will overwrite most of the fields on the character sheet. Are you sure you want to continue?' );
	if ( !proceed ){
		document.querySelector( '.import_browser' ).value = null;
		return;
	}
		
	// Read the file provided
	var reader = new FileReader();
	reader.onload = function( e ){
		
		// Convert file contents to data
		var data = null;
		var parser = new DOMParser();
		data = parser.parseFromString( e.target.result, "text/xml" );
		
		// Digest the data into a broker directory
		var directory = {};

		// Add Aliases to the directory
		var aliases = data.getElementsByTagName( 'alias' );
		for ( var i = 0; i < aliases.length; i++ ){
			var name = aliases[ i ].getAttribute( 'name' );
			directory[ name ] = {};
			directory[ name ].node = aliases[ i ].parentNode;
			directory[ name ].value = aliases[ i ].parentNode.getAttribute( 'value' );
			directory[ name ].mods = {};
			var statadds = aliases[ i ].parentNode.getElementsByTagName( 'statadd' );
			for ( var n = 0; n < statadds.length; n++ ){
				var value = statadds[ n ].getAttribute( 'value' );
				var type = statadds[ n ].getAttribute( 'type' );
				if ( !value || !type )
					continue;
				if ( directory[ name ].mods[ type ] ){
					if ( value > directory[ name ].mods[ type ] ){
						directory[ name ].mods[ type ] = value;
					}
				}
				else{
					directory[ name ].mods[ type ] = value;
				}
			}
		}
		
		// Add Details to the directory
		var details = data.getElementsByTagName( 'Details' )[ 0 ].childNodes;
		for ( var i = 0; i < details.length; i++ ){
			var name = details[ i ].tagName;
			if ( !directory[ name ] && name ){
				directory[ name ] = {};
				directory[ name ].value = csx_clean( details[ i ].textContent );
			}
		}
		
		// Add RulesElements to the directory
		var elements = data.getElementsByTagName( 'RulesElementTally' )[0].getElementsByTagName( 'RulesElement' );
		for ( var i = 0; i < elements.length; i++ ){
			var type = elements[ i ].getAttribute( 'type' );
			var name = elements[ i ].getAttribute( 'name' );
			if ( type && name ){
				if ( !directory[ type ] )
					directory[ type ] = {};
				if ( !directory[ type ].entries )
					directory[ type ].entries = [];
					
				var entry = {};
				entry.node = elements[ i ];
				entry.name = name;
				entry.url = elements[ i ].getAttribute( 'url' );
				var specific = elements[ i ].getElementsByTagName( 'specific' )[0];
				if ( specific )
					entry.desc = csx_clean( specific.textContent );
				directory[ type ].entries.push( entry );
				directory[ type ].value = name;
			}
		}
		
		// Add Power details to the directory
		directory[ 'Daily Powers' ] = {};
		directory[ 'Daily Powers' ][ 'entries' ] = [];
		directory[ 'Encounter Powers' ] = {};
		directory[ 'Encounter Powers' ][ 'entries' ] = [];
		directory[ 'At-Will Powers' ] = {};
		directory[ 'At-Will Powers' ][ 'entries' ] = [];
		
		var powers = data.getElementsByTagName( 'Power' );
		for ( var i = 0; i < powers.length; i++ ){
			var usage = csx_clean( powers[ i ].getElementsByTagName( 'specific' )[0].textContent );
			if ( usage.match( /Encounter/ ) )
				usage = 'Encounter';
			else if ( usage.match( /Daily/ ) )
				usage = 'Daily';
			else if ( usage.match( /At-Will/ ) )
				usage = 'At-Will';
			else
				continue;
				
			var name = powers[ i ].getAttribute( 'name' );
			
			directory[ usage + ' Powers' ].entries.push( { "name":name, "usage":usage, "node":powers[ i ] } );
		}
		
		// Make sure things we'll do math on are numbers
		directory[ 'Strength modifier' ].value = parseInt( directory[ 'Strength modifier' ].value );
		directory[ 'Constitution modifier' ].value = parseInt( directory[ 'Constitution modifier' ].value );
		directory[ 'Dexterity modifier' ].value = parseInt( directory[ 'Dexterity modifier' ].value );
		directory[ 'Intelligence modifier' ].value = parseInt( directory[ 'Intelligence modifier' ].value );
		directory[ 'Wisdom modifier' ].value = parseInt( directory[ 'Wisdom modifier' ].value );
		directory[ 'Charisma modifier' ].value = parseInt( directory[ 'Charisma modifier' ].value );
		directory[ 'HALF-LEVEL' ].value = parseInt( directory[ 'HALF-LEVEL' ].value );
		directory[ 'Hit Points' ].value = parseInt( directory[ 'Hit Points' ].value );
		directory[ 'AC' ].mods[ 'Armor' ] = parseInt( directory[ 'AC' ].mods[ 'Armor' ] );

		// Handle one-offs and special cases
		directory[ 'Base Speed' ] = {};
		directory[ 'Base Speed' ].value = directory[ 'Speed' ].node.getElementsByTagName( 'statadd' )[0].getAttribute( 'value' );
		
		directory[ 'Strength Plus Half Level' ] = { "value":directory[ 'Strength modifier' ].value + directory[ 'HALF-LEVEL' ].value };
		directory[ 'Constitution Plus Half Level' ] = { "value":directory[ 'Constitution modifier' ].value + directory[ 'HALF-LEVEL' ].value };
		directory[ 'Dexterity Plus Half Level' ] = { "value":directory[ 'Dexterity modifier' ].value + directory[ 'HALF-LEVEL' ].value };
		directory[ 'Intelligence Plus Half Level' ] = { "value":directory[ 'Intelligence modifier' ].value + directory[ 'HALF-LEVEL' ].value };
		directory[ 'Wisdom Plus Half Level' ] = { "value":directory[ 'Wisdom modifier' ].value + directory[ 'HALF-LEVEL' ].value };
		directory[ 'Charisma Plus Half Level' ] = { "value":directory[ 'Charisma modifier' ].value + directory[ 'HALF-LEVEL' ].value };
		directory[ 'Ten Plus Half Level' ] = { "value":directory[ 'HALF-LEVEL' ].value + 10 };
		
		directory[ 'AC Ability Modifier' ] = { "value":Math.max( directory[ 'Dexterity modifier' ].value, directory[ 'AC' ].mods[ 'Armor' ] ) };
		directory[ 'Fortitude Ability Modifier' ] = { "value":Math.max( directory[ 'Strength modifier' ].value, directory[ 'Constitution modifier' ].value ) };
		directory[ 'Reflex Ability Modifier' ] = { "value":Math.max( directory[ 'Dexterity modifier' ].value, directory[ 'Intelligence modifier' ].value ) };
		directory[ 'Will Ability Modifier' ] = { "value":Math.max( directory[ 'Wisdom modifier' ].value, directory[ 'Charisma modifier' ].value ) };
		
		directory[ 'Surge Value' ] = { "value":Math.round( directory[ 'Hit Points' ].value / 4 ) };
		directory[ 'Bloodied Value' ] = { "value":Math.round( directory[ 'Hit Points' ].value / 2 ) };
		
		// Send the digested data off to be useful
		csx_applyData( directory );
		
	}
	reader.readAsText( file );
}

function csx_applyData( directory ){

	var fields = csx_opts.defaultContext.querySelectorAll( '.dsf' );
	for ( var i = 0; i < fields.length; i++ ){
		
		var name = fields[ i ].className.match( /dsf_[\w\d_]+/ )[0];
		if ( !name )
			continue;
		
		var key = csx_ddi_schema[ name ];
		if ( !key )
			continue;

		if ( typeof key == 'object' ){
			var source = directory[ key.source ];
			if ( !source )
				continue;
			
			var data = [];
			for ( var n = 0; n < source.entries.length; n++ ){
				var entry = {};
				for ( var field in key.fields ){
					entry[ field ] = source.entries[ n ][ key.fields[ field ] ];
				}
				data.push( entry );
			}
			
			fields[ i ].innerHTML = JSON.stringify( data );
			fields[ i ].parentNode.load();
		}
		else{
			var mod = false;
			if ( key.match( /\.[\w\s\d]+$/ ) )
				mod = key.replace( /^[\w\s\d]+\./, '' );
			
			key = key.replace( /\.[\w\s\d]+$/, '' );
			
			var source = directory[ key ];
			if ( !source )
				continue;
			
			var value = source.value;
			if ( mod ){
				if ( source.mods ){
					value = source.mods[ mod ];
					if ( !value )
						continue;
				}
				else
					continue;
			}
			
			if ( parseInt( value ) == 0 )
				continue;
			
			fields[ i ].innerHTML = value;
		}
		
	}
	
	// Call the callback for UI purposes
	document.querySelector( '.import_browser' ).value = null;
	csx_importDone();
	
}

function csx_clean( string ){

	return string.replace( /^[\s]+/,'').replace( /[\s]+$/,'' );

}

function csx_importDone(){
	document.querySelector( '.import_confirm' ).style.display = 'inline-block';
}